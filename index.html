<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Ai test 2</title>
    <style>
        #vidDiv{
            position: relative;
        }
        #otherVidDiv{
            position: absolute;
            border: solid greenyellow 3px;
        }
        #errorMessage{
            font-size: 75px;
            background-color: blue;
            color: red;
        }
    </style>
    <link rel="manifest" href="manifest.json">
</head>
<body>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"> </script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"> </script>
    <h1 id="displayCatTxtPerdictions">  </h1>
    <h1 id="displayCatNumPerdictions">  </h1>
    <div id="vidDiv">
        <div id="otherVidDiv">
            
        </div>
        <video id="video"></video>
    </div>
    <button onclick="buttonclicked()">  START  </button>
    <h1 id="errorMessage"></h1>
    <script>

    if ('serviceWorker' in navigator) {
        alert("Will the service worker register?");
        navigator.serviceWorker.register('serviceworker.js')
        .then(function(reg){
            alert("Yes, it did.");
        }).catch(function(err) {
            alert("No it didn't. This happened: ", err)
        });
    }
        alert('plese do not click anthing untill you get the message "startup finished"')
        var video = document.getElementById('video');
        var loadedmodel; 
        async function start() {
                loadedmodel = await cocoSsd.load()
                if(navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(function(stream) {
                        //video.src = window.URL.createObjectURL(stream);
                        video.srcObject = stream;
                        video.play();
                        alert("THERE IS A STREAM")
                    });
                }
                    };
                function buttonclicked() {
                    alert("button clicked")
                    loadedmodel.detect(video).then(predictions => {
                        if (predictions.length == 0) {
                            document.getElementById("errorMessage").innerText = "Plese try again"
                            return
                        } else {
                            document.getElementById("errorMessage").innerText = ""
                        }
                        console.log(predictions)
                        alert("stuff was perdicted")
                        document.getElementById("displayCatTxtPerdictions").innerText = "This is a " + predictions[0].class + "."
                        document.getElementById("displayCatNumPerdictions").innerText = "Confidence level: " + Math.ceil(predictions[0].score * 100) + "%"
                        console.log('Predictions: ', predictions);
                        document.getElementById("otherVidDiv").style.left = predictions[0].bbox[0]-3 + 'px';
                        document.getElementById("otherVidDiv").style.top = predictions[0].bbox[1]-3 + 'px';
                        document.getElementById("otherVidDiv").style.width = predictions[0].bbox[2]-3 + 'px';
                        document.getElementById("otherVidDiv").style.height = predictions[0].bbox[3]-3 + 'px';
                        })
                }

        start().then( () => {alert('startup finished')})
    </script>
    
</body>
</html>